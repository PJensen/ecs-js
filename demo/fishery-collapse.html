<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ecs-js — Fishery Collapse Demo</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0d1117;
      --panel: #0f172a;
      --panel-2: #111827;
      --accent: #67e8f9;
      --warn: #fcd34d;
      --err: #f87171;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(103, 232, 249, 0.08), transparent 30%),
                  radial-gradient(circle at 70% 0%, rgba(252, 211, 77, 0.08), transparent 25%),
                  var(--bg);
      color: #e5e7eb;
      padding: 1.25rem clamp(1rem, 2vw, 3rem);
      line-height: 1.5;
    }
    h1 { margin: 0 0 0.25rem; letter-spacing: -0.01em; }
    h2 { margin: 0 0 0.35rem; }
    p { margin: 0.25rem 0 0.5rem; max-width: 80ch; }
    .panel {
      background: var(--panel);
      border: 1px solid #1f2937;
      border-radius: 14px;
      padding: 1.1rem 1.15rem;
      box-shadow: 0 12px 48px rgba(0,0,0,0.35);
      margin: 0 0 1rem;
    }
    .panel.alt { background: var(--panel-2); }
    .layout { display: grid; grid-template-columns: 1.1fr 1fr; gap: 1rem; align-items: stretch; }
    .layout stack { display: block; }
    .controls { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; }
    label { font-size: 0.9rem; opacity: 0.85; }
    input[type="number"], input[type="text"] { width: 8rem; padding: 0.4rem 0.55rem; border-radius: 10px; border: 1px solid #243143; background: #0b1626; color: #e5e7eb; }
    input[type="range"] { accent-color: var(--accent); cursor: pointer; }
    .slider { display: grid; grid-template-columns: 1fr auto; gap: 0.25rem 0.75rem; align-items: center; }
    .slider span { font-feature-settings: 'tnum' 1; opacity: 0.9; }
    .slider small { opacity: 0.65; font-size: 0.8rem; }
    button {
      border: 1px solid #243143;
      border-radius: 12px;
      padding: 0.65rem 1.1rem;
      background: linear-gradient(135deg, #1b273f, #19233a);
      color: #e5e7eb;
      cursor: pointer;
      transition: background 120ms ease, transform 120ms ease, box-shadow 120ms ease;
    }
    button:hover { background: #1f2b42; box-shadow: 0 12px 30px rgba(103,232,249,0.18); }
    button:active { transform: translateY(1px); }
    .pill { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.7rem; border-radius: 999px; font-size: 0.85rem; background: #13203b; border: 1px solid #1f2937; }
    .pill em { color: var(--accent); font-style: normal; font-weight: 700; }
    table { width: 100%; border-collapse: collapse; margin-top: 0.35rem; }
    th, td { padding: 0.45rem 0.45rem; text-align: right; font-variant-numeric: tabular-nums; }
    th { text-align: right; font-weight: 600; opacity: 0.8; }
    tr:nth-child(odd) { background: rgba(255,255,255,0.02); }
    .status { text-align: left; }
    .ok { color: #bef264; }
    .warn { color: var(--warn); }
    .err { color: var(--err); }
    .small { font-size: 0.9rem; opacity: 0.8; }
    .notes { white-space: pre-line; font-family: "SFMono-Regular", Consolas, monospace; background: #0b1626; padding: 0.85rem; border-radius: 10px; border: 1px solid #1f2937; }
    .scene-wrap { position: relative; }
    canvas { border-radius: 10px; border: 1px solid #1f2937; background: #0b1626; }
    .legend { display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.9rem; opacity: 0.85; }
    .chip { width: 12px; height: 12px; border-radius: 999px; display: inline-block; }
    @media (max-width: 960px) { .layout { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header class="panel">
    <div class="layout" style="align-items:flex-start; gap: 1.25rem;">
      <div>
        <h1>Fishery collapse (one-shot demo)</h1>
        <p>Showcase of <code>ecs-js</code> as a simulation canvas: a stock grows logistically, boats search as agents, policy reins them in, and collapse detection trips a warning. All of it ticks deterministically from a single seed.</p>
        <div class="controls" aria-label="Simulation controls">
          <label for="seed">Seed</label>
          <input id="seed" type="text" value="0xc0ffee" inputmode="numeric" />
          <label for="years">Years</label>
          <input id="years" type="number" value="30" min="1" max="160" />
          <button id="run">Restart</button>
          <label class="pill" style="cursor:pointer;">
            <input id="continuous" type="checkbox" checked style="accent-color:var(--accent);" />
            Continuous
          </label>
          <span class="pill" id="headline">Waiting to run…</span>
        </div>
        <div class="panel alt" style="margin:0.75rem 0 0;">
          <div class="layout" style="grid-template-columns: 1fr 1fr; gap: 0.85rem;">
            <div class="slider">
              <div>
                <label for="fleet">Fleet size</label><br />
                <small>Boats act as agents; more boats amplify harvesting pressure.</small>
              </div>
              <span id="fleetValue">9</span>
              <input id="fleet" type="range" min="3" max="20" value="9" step="1" />
              <span></span>
            </div>
            <div class="slider">
              <div>
                <label for="effort">Base effort</label><br />
                <small>Throttle each boat before policy/biomass feedback.</small>
              </div>
              <span id="effortValue">0.24</span>
              <input id="effort" type="range" min="0.08" max="0.35" value="0.24" step="0.01" />
              <span></span>
            </div>
            <div class="slider">
              <div>
                <label for="growth">Growth rate</label><br />
                <small>Biomass rebound each year (logistic).</small>
              </div>
              <span id="growthValue">0.58</span>
              <input id="growth" type="range" min="0.38" max="0.9" value="0.58" step="0.01" />
              <span></span>
            </div>
            <div class="slider">
              <div>
                <label for="strict">Policy strictness</label><br />
                <small>How aggressively the regulator throttles effort when biomass dips.</small>
              </div>
              <span id="strictValue">0.65</span>
              <input id="strict" type="range" min="0.35" max="1.2" value="0.65" step="0.01" />
              <span></span>
            </div>
          </div>
        </div>
        <p class="small">Phases each tick: <code>growth → fleet-search → harvest → policy → detect → log</code>. Adjust sliders then rerun to see how agents and policy reshape the outcome without breaking determinism.</p>
      </div>
      <div class="scene-wrap">
        <canvas id="scene" width="460" height="280" aria-label="Boats searching for a fish school"></canvas>
      </div>
    </div>
    <div style="margin-top:1rem;">
      <h2 style="margin:0 0 0.35rem;">Topline trajectory</h2>
      <div class="legend">
        <span class="chip" style="background:#67e8f9"></span> Biomass
        <span class="chip" style="background:#fcd34d"></span> Catch
        <span class="chip" style="background:#f87171"></span> Collapse gate
      </div>
      <canvas id="chart" width="980" height="260" aria-label="Biomass and catch over time"></canvas>
    </div>
  </header>

  <section class="panel">
    <h2>Year-by-year trajectory</h2>
    <table aria-label="Fishery outcomes">
      <thead>
        <tr>
          <th class="status">Year</th>
          <th>Biomass (kt)</th>
          <th>Catch (kt)</th>
          <th>Effort</th>
          <th>State</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>
  </section>

  <section class="panel">
    <h2>Scenario notes</h2>
    <div class="notes" id="notes"></div>
  </section>

  <script type="module">
    import { World, defineComponent, defineTag } from '../core.js';
    import { composeScheduler } from '../systems.js';
    import { createRealtimeRafLoop } from '../adapters/raf-adapters.js';

    const Stock = defineComponent('Stock', { biomass: 120, carrying: 200, growth: 0.6, noise: 0.08 });
    const Harvest = defineComponent('Harvest', { effort: 0.4, catchability: 0.03, maxEffort: 1.2 });
    const CollapseGate = defineComponent('CollapseGate', { at: 0.25, detected: false, year: null });
    const Pulse = defineComponent('Pulse', { catch: 0 });
    const Year = defineComponent('Year', { value: 0 });
    const FleetControl = defineComponent('FleetControl', { fleetSize: 9, baseEffort: 0.24, strictness: 0.65, search: 0.55 });
    const Boat = defineComponent('Boat', { x: 0.4, y: 0.55, heading: 0, throttle: 0.6, color: '#67e8f9' });
    const Collapsed = defineTag('Collapsed');

    const rowsEl = document.getElementById('rows');
    const headlineEl = document.getElementById('headline');
    const notesEl = document.getElementById('notes');
    const seedInput = document.getElementById('seed');
    const yearsInput = document.getElementById('years');
    const continuousInput = document.getElementById('continuous');
    const runBtn = document.getElementById('run');
    const chartEl = document.getElementById('chart');
    const chartCtx = chartEl.getContext('2d');
    const sceneEl = document.getElementById('scene');
    const sceneCtx = sceneEl.getContext('2d');
    const sliders = {
      fleet: document.getElementById('fleet'),
      fleetValue: document.getElementById('fleetValue'),
      effort: document.getElementById('effort'),
      effortValue: document.getElementById('effortValue'),
      growth: document.getElementById('growth'),
      growthValue: document.getElementById('growthValue'),
      strict: document.getElementById('strict'),
      strictValue: document.getElementById('strictValue'),
    };

    const fmt = (n, digits = 2) => Number(n).toFixed(digits);

    const stateLabel = (ratio) => {
      if (ratio < 0.15) return ['Collapsed', 'err'];
      if (ratio < 0.35) return ['Precarious', 'warn'];
      return ['Healthy', 'ok'];
    };

    const wrap01 = (v) => {
      if (v < 0) return 1 + (v % 1);
      if (v > 1) return v % 1;
      return v;
    };

    function syncSlider(key) {
      sliders[`${key}Value`].textContent = fmt(sliders[key].value, key === 'fleet' ? 0 : 2);
    }

    ['fleet', 'effort', 'growth', 'strict'].forEach((k) => {
      syncSlider(k);
      sliders[k].addEventListener('input', () => syncSlider(k));
    });

    const HISTORY_LIMIT = 720;
    let activeLoop = null;

    function buildWorld(seed, config) {
      const world = new World({ seed, store: 'map' });
      world.setScheduler(composeScheduler('growth', 'fleet', 'harvest', 'policy', 'detect', 'log'));

      const stock = world.create();
      world.add(stock, Stock, { biomass: 160, carrying: 230, growth: config.growth, noise: 0.06 });
      world.add(stock, Harvest, { effort: 0.42, catchability: 0.028, maxEffort: 1.15 });
      world.add(stock, CollapseGate, { at: 0.22 });
      world.add(stock, Pulse, { catch: 0 });
      world.add(stock, Year, { value: 0 });

      const fleet = world.create();
      world.add(fleet, FleetControl, { fleetSize: config.fleetSize, baseEffort: config.baseEffort, strictness: config.strictness, search: 0.55 });

      const boats = [];
      for (let i = 0; i < config.fleetSize; i += 1) {
        const angle = world.rand() * Math.PI * 2;
        const radius = 0.1 + world.rand() * 0.1;
        const boat = world.create();
        world.add(boat, Boat, {
          x: 0.45 + Math.cos(angle) * radius,
          y: 0.55 + Math.sin(angle) * radius,
          heading: angle,
          throttle: 0.5 + (world.rand() - 0.5) * 0.25,
          color: `hsl(${185 + i * 5}, 70%, 65%)`,
        });
        boats.push(boat);
      }

      world.system((w, dt) => {
        for (const [_id, s] of w.query(Stock)) {
          const growth = s.growth * s.biomass * (1 - s.biomass / s.carrying) * dt;
          const jitter = (w.rand() - 0.5) * 2 * s.noise * s.biomass;
          s.biomass = Math.max(1, Math.min(s.carrying, s.biomass + growth + jitter));
        }
      }, 'growth');

      world.system((w, dt) => {
        const s = w.get(stock, Stock);
        const h = w.get(stock, Harvest);
        const control = w.get(fleet, FleetControl);
        let totalThrottle = 0;
        for (const [_id, boat] of w.query(Boat)) {
          const tension = s.biomass / s.carrying;
          const target = Math.min(1.25, Math.max(0.12, tension * 1.2));
          boat.throttle += (target - boat.throttle) * (0.18 + control.strictness * 0.08);
          boat.heading += (w.rand() - 0.5) * control.search * 0.6;
          boat.x = wrap01(boat.x + Math.cos(boat.heading) * (0.0025 + control.baseEffort * 0.006) * boat.throttle * dt);
          boat.y = wrap01(boat.y + Math.sin(boat.heading) * (0.0015 + control.baseEffort * 0.004) * boat.throttle * dt);
          totalThrottle += boat.throttle;
        }
        const avgThrottle = totalThrottle / Math.max(1, control.fleetSize);
        h.effort = Math.min(h.maxEffort, control.baseEffort * (0.6 + control.strictness * 0.7) * avgThrottle);
      }, 'fleet');

      world.system((w, dt) => {
        for (const [_id, s, h, pulse] of w.query(Stock, Harvest, Pulse)) {
          const catchTarget = s.biomass * h.catchability * h.effort * dt;
          const taken = Math.min(s.biomass, catchTarget);
          s.biomass -= taken;
          pulse.catch = taken;
        }
      }, 'harvest');

      world.system((w) => {
        const s = w.get(stock, Stock);
        const h = w.get(stock, Harvest);
        const control = w.get(fleet, FleetControl);
        const ratio = s.biomass / s.carrying;
        if (ratio < 0.35) {
          h.effort = Math.max(0.04, h.effort * (0.82 - control.strictness * 0.08));
          control.baseEffort = Math.max(0.06, control.baseEffort * (0.9 - control.strictness * 0.06));
          control.search = Math.max(0.25, control.search - 0.04);
        } else if (ratio > 0.7 && h.effort < h.maxEffort) {
          h.effort = Math.min(h.maxEffort, h.effort * (1.02 + control.strictness * 0.02));
          control.baseEffort = Math.min(h.maxEffort, control.baseEffort * (1.01 + control.strictness * 0.012));
          control.search = Math.min(0.95, control.search + 0.01);
        } else {
          control.baseEffort = Math.max(0.08, control.baseEffort * 0.995);
          control.search = Math.max(0.3, control.search * 0.998);
        }
      }, 'policy');

      world.system((w) => {
        for (const [id, s, gate, year] of w.query(Stock, CollapseGate, Year)) {
          const ratio = s.biomass / s.carrying;
          if (ratio < gate.at && !gate.detected) {
            gate.detected = true;
            gate.year = year.value + 1;
            if (!w.has(id, Collapsed)) w.add(id, Collapsed);
          }
        }
      }, 'detect');

      return { world, stock, fleet, boats };
    }

    function runScenario(seed, horizon, config, continuous) {
      if (activeLoop) activeLoop.stop();

      const { world: simWorld, stock, fleet, boats } = buildWorld(seed, config);
      const history = [];

      simWorld.system((w) => {
        const [s, h, pulse, year, gate] = [w.get(stock, Stock), w.get(stock, Harvest), w.get(stock, Pulse), w.get(stock, Year), w.get(stock, CollapseGate)];
        const ratio = s.biomass / s.carrying;
        const collapsed = w.has(stock, Collapsed);
        const [label, cls] = collapsed ? ['Collapsed', 'err'] : stateLabel(ratio);
        year.value += 1;
        history.push({
          year: year.value,
          biomass: s.biomass,
          catch: pulse.catch,
          effort: h.effort,
          label,
          cls,
        });
        if (history.length > HISTORY_LIMIT) history.splice(0, history.length - HISTORY_LIMIT);
      }, 'log');

      const loop = createRealtimeRafLoop({
        world: { step: () => simWorld.tick(1) },
        render: () => {
          const view = history.slice(-horizon);
          const gate = simWorld.get(stock, CollapseGate);
          drawChart(view, horizon, gate);
          drawScene(simWorld, stock, fleet, boats, view[view.length - 1], gate);
        },
        afterFrame: () => {
          const view = history.slice(-horizon);
          render(view, config, simWorld.get(stock, CollapseGate), horizon);
          if (!continuous && history.length >= horizon) {
            loop.stop();
          }
        },
      });

      activeLoop = loop;
      loop.start({ reset: true });
    }

    function render(history, config, gate, horizon) {
      if (!history.length) return;
      rowsEl.innerHTML = history.map((row) => `
        <tr>
          <td class="status">${row.year}</td>
          <td>${fmt(row.biomass / 1000, 3)}</td>
          <td>${fmt(row.catch / 1000, 3)}</td>
          <td>${fmt(row.effort, 3)}</td>
          <td class="${row.cls}">${row.label}</td>
        </tr>
      `).join('');

      const latest = history[history.length - 1];
      headlineEl.innerHTML = `Year <em>${latest.year}</em>: <span class="${latest.cls}">${latest.label}</span> (biomass ${fmt(latest.biomass / 1000, 2)} kt)`;
      const highs = history.reduce((acc, r) => ({
        maxBiomass: Math.max(acc.maxBiomass, r.biomass),
        maxCatch: Math.max(acc.maxCatch, r.catch),
        minBiomass: Math.min(acc.minBiomass, r.biomass),
      }), { maxBiomass: 0, maxCatch: 0, minBiomass: Infinity });

      const collapseYear = gate?.year ?? history.find((r) => r.label === 'Collapsed')?.year ?? '–';
      notesEl.textContent = [
        `Max biomass: ${fmt(highs.maxBiomass / 1000, 2)} kt`,
        `Max catch:   ${fmt(highs.maxCatch / 1000, 2)} kt`,
        `Min biomass: ${fmt(highs.minBiomass / 1000, 2)} kt`,
        `Collapse year: ${collapseYear}`,
        '',
        'Systems & phases:',
        '  1. growth        — logistic rebound with seeded jitter',
        '  2. fleet-search  — boat agents steer and contribute effort',
        '  3. harvest       — biomass removed via catchability * effort',
        '  4. policy        — regulator throttles effort near collapse',
        '  5. detect        — tags collapse once biomass crosses a gate',
        '  6. log           — capture a transcript row for the table',
        '',
        'Config knobs (deterministic):',
        `  - fleet size:      ${config.fleetSize} boats`,
        `  - base effort:     ${fmt(config.baseEffort, 2)} throttle`,
        `  - growth rate:     ${fmt(config.growth, 2)} logistic`,
        `  - policy strict.:  ${fmt(config.strictness, 2)} multiplier`,
        '',
        'Sources:',
        '  - Hilborn & Walters (1992) “Quantitative Fisheries Stock Assessment” — logistic growth & harvest control rules (Ch. 2-4)',
        '  - FAO Fisheries Circular 1011 (2006) — collapse thresholds & rebuilding heuristics',
      ].join('\n');
    }

    function drawChart(history, horizon, gate) {
      const padding = 36;
      const w = chartEl.width;
      const h = chartEl.height;
      chartCtx.clearRect(0, 0, w, h);
      chartCtx.fillStyle = '#0b1626';
      chartCtx.fillRect(0, 0, w, h);
      chartCtx.strokeStyle = '#1f2937';
      chartCtx.lineWidth = 1;
      for (let y = 0; y <= 4; y++) {
        const yPos = padding + ((h - padding * 1.5) / 4) * y;
        chartCtx.beginPath();
        chartCtx.moveTo(padding, yPos);
        chartCtx.lineTo(w - padding / 2, yPos);
        chartCtx.stroke();
      }

      if (!history.length) return;
      const baseYear = history[0]?.year ?? 1;
      const maxBiomass = Math.max(...history.map((d) => d.biomass));
      const maxCatch = Math.max(...history.map((d) => d.catch));
      const xFor = (year) => padding + ((year - baseYear) / Math.max(1, horizon - 1)) * (w - padding * 1.5);
      const yFor = (val, max) => h - padding - (val / Math.max(1, max)) * (h - padding * 1.75);

      chartCtx.beginPath();
      history.forEach((d) => {
        const x = xFor(d.year);
        const y = yFor(d.biomass, maxBiomass);
        if (d.year === baseYear) chartCtx.moveTo(x, y);
        else chartCtx.lineTo(x, y);
      });
      chartCtx.strokeStyle = '#67e8f9';
      chartCtx.lineWidth = 2.5;
      chartCtx.shadowColor = 'rgba(103, 232, 249, 0.35)';
      chartCtx.shadowBlur = 12;
      chartCtx.stroke();
      chartCtx.shadowBlur = 0;

      chartCtx.beginPath();
      history.forEach((d) => {
        const x = xFor(d.year);
        const y = yFor(d.catch, maxCatch || 1);
        if (d.year === baseYear) chartCtx.moveTo(x, y);
        else chartCtx.lineTo(x, y);
      });
      chartCtx.strokeStyle = '#fcd34d';
      chartCtx.lineWidth = 2;
      chartCtx.stroke();

      const latest = history[history.length - 1];
      const collapsedYear = gate?.year ?? history.find((d) => d.label === 'Collapsed')?.year;
      chartCtx.fillStyle = '#e5e7eb';
      chartCtx.font = '12px system-ui, sans-serif';
      if (collapsedYear) {
        const cx = xFor(collapsedYear);
        chartCtx.strokeStyle = '#f87171';
        chartCtx.setLineDash([6, 5]);
        chartCtx.beginPath();
        chartCtx.moveTo(cx, padding / 2);
        chartCtx.lineTo(cx, h - padding / 2);
        chartCtx.stroke();
        chartCtx.setLineDash([]);
      }

      chartCtx.fillStyle = '#9ca3af';
      chartCtx.fillText(`Latest biomass: ${fmt(latest.biomass / 1000, 2)} kt`, w - 240, 16);
    }

    const pseudo = (seed, salt = 1) => {
      const x = Math.sin(seed * 127.1 + salt * 311.7) * 43758.5453;
      return x - Math.floor(x);
    };

    function drawScene(world, stock, fleet, boats, latestRow, gate) {
      const w = sceneEl.width;
      const h = sceneEl.height;
      sceneCtx.clearRect(0, 0, w, h);
      sceneCtx.fillStyle = '#0b1626';
      sceneCtx.fillRect(0, 0, w, h);

      const s = world.get(stock, Stock);
      const ratio = s.biomass / s.carrying;
      const glow = Math.max(0.18, Math.min(0.9, ratio));
      const schoolRadius = 60 + ratio * 70;
      const centerX = w * 0.55;
      const centerY = h * 0.52 + (pseudo((latestRow?.year || 0) + ratio, 2) - 0.5) * 12;

      const shimmer = (i) => 0.85 + (pseudo(i, ratio) - 0.5) * 0.2;
      sceneCtx.fillStyle = `rgba(103, 232, 249, ${glow * 0.4})`;
      sceneCtx.beginPath();
      sceneCtx.ellipse(centerX, centerY, schoolRadius, schoolRadius * 0.6, 0, 0, Math.PI * 2);
      sceneCtx.fill();

      for (let i = 0; i < 120; i += 1) {
        const angle = (pseudo(i, latestRow?.year || 0) + i * 0.01) * Math.PI * 2;
        const r = schoolRadius * (0.15 + shimmer(i) * 0.4) * (pseudo(i, 5) * 0.75);
        const x = centerX + Math.cos(angle) * r;
        const y = centerY + Math.sin(angle) * r * 0.6;
        sceneCtx.fillStyle = `rgba(103, 232, 249, ${0.15 + glow * 0.35})`;
        sceneCtx.beginPath();
        sceneCtx.arc(x, y, 2 + shimmer(i) * 1.6, 0, Math.PI * 2);
        sceneCtx.fill();
      }

      for (const [_id, boat] of world.query(Boat)) {
        const x = boat.x * w;
        const y = boat.y * h;
        const size = 12 + boat.throttle * 6;
        sceneCtx.save();
        sceneCtx.translate(x, y);
        sceneCtx.rotate(boat.heading);
        sceneCtx.fillStyle = boat.color;
        sceneCtx.beginPath();
        sceneCtx.moveTo(size, 0);
        sceneCtx.lineTo(-size * 0.6, size * 0.55);
        sceneCtx.lineTo(-size * 0.6, -size * 0.55);
        sceneCtx.closePath();
        sceneCtx.fill();
        sceneCtx.fillStyle = '#0b1626';
        sceneCtx.globalAlpha = 0.4;
        sceneCtx.beginPath();
        sceneCtx.ellipse(-size * 0.2, 0, size * 0.9, size * 0.55, 0, 0, Math.PI * 2);
        sceneCtx.fill();
        sceneCtx.restore();
      }

      sceneCtx.fillStyle = '#9ca3af';
      sceneCtx.font = '12px system-ui, sans-serif';
      sceneCtx.fillText(`Boats: ${world.get(fleet, FleetControl).fleetSize} | Effort: ${fmt(world.get(stock, Harvest).effort, 2)} | Biomass: ${fmt(s.biomass / 1000, 2)} kt`, 12, h - 12);
      if (gate?.year) {
        sceneCtx.fillStyle = '#f87171';
        sceneCtx.fillText(`Collapse detected in year ${gate.year}`, 12, 20);
      }
    }

    function start() {
      const seed = parseInt(seedInput.value, 0) >>> 0;
      const years = Math.max(1, Math.min(Number(yearsInput.value) || 0, 200));
      const config = {
        fleetSize: Number(sliders.fleet.value),
        baseEffort: Number(sliders.effort.value),
        growth: Number(sliders.growth.value),
        strictness: Number(sliders.strict.value),
      };
      seedInput.value = seed;
      yearsInput.value = years;
      rowsEl.innerHTML = '';
      headlineEl.textContent = 'Running…';
      runScenario(seed, years, config, continuousInput.checked);
    }

    runBtn.addEventListener('click', start);
    start();
  </script>
</body>
</html>

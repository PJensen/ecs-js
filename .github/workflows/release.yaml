name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: {}

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      ESBUILD_VERSION: 0.27.0  # matches scoped @esbuild/* binaries
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Derive version
        id: vars
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Download esbuild binary (no Node)
        run: |
          curl -fsSL \
            "https://registry.npmjs.org/@esbuild/linux-x64/-/linux-x64-${ESBUILD_VERSION}.tgz" \
            -o esbuild.tgz
          tar -xzf esbuild.tgz
          mv package/bin/esbuild ./esbuild
          chmod +x ./esbuild

      - name: Build single-file ECMAScript bundle
        run: |
          mkdir -p dist
          ./esbuild ./index.js \
            --bundle \
            --platform=browser \
            --format=iife \
            --global-name=ECS \
            --minify \
            --legal-comments=none \
            --target=es2018 \
            --banner:js="/*! ecs-js v${{ steps.vars.outputs.VERSION }} */" \
            --outfile=dist/ecs-${{ steps.vars.outputs.VERSION }}-min.js

      - name: Create GitHub Release (if not exists)
        run: |
          gh release view "v${{ steps.vars.outputs.VERSION }}" >/dev/null 2>&1 || \
            gh release create "v${{ steps.vars.outputs.VERSION }}" \
              --title "ecs-js v${{ steps.vars.outputs.VERSION }}" \
              --notes "Automated release for ecs-js v${{ steps.vars.outputs.VERSION }}"

      - name: Upload artifact to GitHub Release
        run: |
          gh release upload "v${{ steps.vars.outputs.VERSION }}" \
            dist/ecs-${{ steps.vars.outputs.VERSION }}-min.js \
            --clobber
